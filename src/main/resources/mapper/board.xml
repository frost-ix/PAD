<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Board">
	<select id="getMyBoardList" parameterType="map" resultType="BoardImgVO">
		SELECT ROWNUM, boardid, boardtitle, memID ,imagepath, cateID
		FROM (
			SELECT b.boardid, b.boardtitle, b.memID ,b.regdate, i.imagetype, i.imagepath, b.cateID,
				ROW_NUMBER()
				OVER(PARTITION BY b.boardid
					ORDER BY
						CASE WHEN i.imagetype = 'thumbnail' OR i.imagetype = NULL
								THEN 1
							ELSE 2
						END) as rn
			FROM board b
			JOIN image i ON b.boardid = i.boardid
			WHERE b.boardID &gt;= #{currentBoardID} AND b.memID = #{memID}
		)
		WHERE ROWNUM &lt;= 9
		AND imagetype = 'thumbnail'
		ORDER BY boardid DESC, rn ASC
	</select>

	<select id="getBoardOne" parameterType="int" resultType="BoardImgCateVO">
		SELECT c.CATENAME , b.BOARDID, b.BOARDTITLE, m.MEMNN  , b.BOARDCONTENT , b.REGDATE , i.IMAGEPATH
		FROM BOARD b
		JOIN "MEMBER" m ON m.MEMID = b.MEMID
		JOIN CATEGORY c ON b.CATEID = c.CATEID
		JOIN IMAGE i ON i.BOARDID = b.BOARDID
		WHERE b.BOARDID = #{boardID} AND i.IMAGETYPE = 'content'
	</select>

    <select id="getBoardList" resultType="BoardVO">
		select * from board
	</select>

	<select id="getBoardMax" resultType="int">
		select count(*) from board
	</select>

	<select id="getMyBoardMax" parameterType="String" resultType="int">
		select count(*) from board b where b.memid = #{memID}
	</select>

	<select id="getThumbnailList" parameterType="int" resultType="BoardImgCateVO">
		SELECT ROWNUM, boardid, boardtitle, imagepath
		FROM (
			SELECT b.boardid, b.boardtitle, b.regdate, i.imagetype, i.imagepath,
				ROW_NUMBER()
				OVER(PARTITION BY b.boardid
					ORDER BY
						CASE WHEN i.imagetype = 'thumbnail' OR i.imagetype = NULL
								THEN 1
							ELSE 2
						END) as rn
			FROM board b
			JOIN image i ON b.boardid = i.boardid
			WHERE b.boardID &gt;= #{currentBoardID}
		)
		WHERE rn = 1
		AND ROWNUM &lt;= 9
		<if test="cateID != null">
		AND CATEID = #{cateID}
		</if>
		ORDER BY boardid DESC
	</select>

	<insert id="insertBoard" parameterType="BoardImgVO">
		insert into board (boardid, boardtitle, boardcontent, regdate, cateid, memid)
		values (BOARDID_SEQ.nextval, #{boardTitle}, #{boardContent}, sysdate, #{cateID}, #{memID})
		</insert>

	<insert id="insertImage" parameterType="BoardImgVO">
		insert into image (imageid, imagetype, imagepath, boardid)
		values (IMAGEID_SEQ.nextval, #{imgType}, #{imagePath}, BOARDID_SEQ.currval)
	</insert>

	<update id="updateBoard" parameterType="BoardImgVO">
		UPDATE BOARD b
			SET
				b.BOARDTITLE = #{boardTitle},
				b.BOARDCONTENT = #{boardContent},
				b.CATEID = #{cateID}
		WHERE b.BOARDID = #{boardID}
	</update>

	<update id="updateImage" parameterType="imgVO">
		UPDATE IMAGE i
		<set>
			<foreach collection="imagePath" item="image">
				<if test="item == 'thumbnail'">
					i.IMAGEPATH = #{image}
				</if>
			</foreach>
		</set>
		WHERE i.BOARDID = #{boardID}		
		AND i.IMAGETYPE = #{imageType}
	</update>

	<delete id="deleteBoard" parameterType="int">
		delete from board where boardid = #{boardID}
	</delete>
</mapper>